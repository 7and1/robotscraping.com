name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy-api:
    name: Deploy Cloudflare API Worker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Create wrangler.toml from example
        run: |
          cd workers/api
          # Create wrangler.toml from example, replacing database_id
          sed "s/YOUR_D1_DATABASE_ID/${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}/g" wrangler.toml.example > wrangler.toml

      - name: Deploy Worker with secrets
        run: |
          cd workers/api
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            npx wrangler deploy --secret "OPENAI_API_KEY:${{ secrets.OPENAI_API_KEY }}"
          else
            npx wrangler deploy
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment summary
        run: |
          echo "### Worker deployed successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Worker name:** robot-scraping-core" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://robot-scraping-core.butterflywork.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
